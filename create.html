<!DOCTYPE html>
<html lang="de">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Neuer Artikel</title>
  <!-- TinyMCE einbinden -->
  <script src="tinymce/js/tinymce/tinymce.min.js"></script>
  <script>

    tinymce.init({
      selector: 'textarea[name="content"]',
      license_key: 'gpl',
      language: 'de',
      language_url: '/tinymce/langs/de.js',
      plugins: [
    'advlist', 'autolink', 'lists', 'link', 'image', 'charmap', 'preview',
    'anchor', 'searchreplace', 'visualblocks', 'code', 'fullscreen',
    'insertdatetime', 'media', 'table', 'help', 'wordcount'
  ],
  toolbar: 'undo redo | blocks | ' +
  'bold italic backcolor | alignleft aligncenter ' +
  'alignright alignjustify | bullist numlist outdent indent | ' +
  'removeformat | help',
      
      menubar: false,
      branding: false,
      height: 400,
      setup: function (editor) {
        editor.on('change', function () {
          editor.save();
        });
      },

      automatic_uploads: false,
      images_upload_handler: function (blobInfo, success, failure) {
        // Bild als Blob lesen
        const reader = new FileReader();
        reader.readAsDataURL(blobInfo.blob());
        reader.onload = function () {
          const img = new Image();
          img.src = reader.result;
          img.onload = function () {
            // Neues Canvas erzeugen
            const canvas = document.createElement('canvas');
            const maxSize = 240; // Maximal 240x240 Pixel
            let width = img.width;
            let height = img.height;

            // Größenanpassung
            if (width > height) {
              if (width > maxSize) {
                height = Math.round(height * (maxSize / width));
                width = maxSize;
              }
            } else {
              if (height > maxSize) {
                width = Math.round(width * (maxSize / height));
                height = maxSize;
              }
            }

            canvas.width = width;
            canvas.height = height;

            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);

            // Bild wieder als Base64 exportieren
            //const resizedDataUrl = canvas.toDataURL(blobInfo.blob().type);
            // <<< WICHTIG: Jetzt als JPEG exportieren mit 80% Qualität!
            const resizedDataUrl = canvas.toDataURL('image/jpeg', 0.8);

            success(resizedDataUrl);
          };
          img.onerror = function () {
            failure('Konnte Bild nicht laden.');
          };
        };
        reader.onerror = function () {
          failure('Konnte Datei nicht lesen.');
        };
      }
    });
  </script>
</head>

<body>
  <h1>Neuen Artikel erstellen</h1>
  <form action="/" method="post">
    <input type="text" name="title" placeholder="Titel" required><br><br>
    <textarea name="content" placeholder="Inhalt" rows="10" required></textarea><br><br>
    <button type="submit">Veröffentlichen</button>
  </form>
</body>

</html>
